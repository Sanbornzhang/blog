---
title: 短信验证码设计
date: 2019/4/30
categories: 短信服务
tags: 
  - 短信服务
  - 短信服务设计
---
# 短信验证码登录
## 场景
用户忘记密码，这个是必须存在的一个场景，不管是通过邮件的方式或者是通过短信验证码的方式。一个系统中必须存在用户找回密码的场景。
<!--more--> 
## 设计
### 短信的可用性
1. 通过第三方短信提供商发送短信到用户手机中
2. 因为运有的提供商有策略：不能在 ` 60S ` 发送两次。
3. 短信的补发机制
   1. 有的短信提供商并没有提供失败查询的接口.
   2. 有的有但是依然不是很全面.  
  大多都是依靠用户在60S的时间内没有收到短信手动点击的
4. 多个短信提供商，有可能针对个别用户电话号码收不到的情况。所以需要多个提供商。手动实现轮询算法。[当然也可以加权]
5. 日志收集短信提供商的发送记录，当然也可以从运营提供商收集。[*但是有的也会存在不准确的情况, 这样也方便后期的加权处理*]
### 验证码的可用性
1. 缓存: redis。
   - 需要支持服务的水平扩展那么肯定不会自己手写放在服务的内存中
   - 数据结构上会采用hash的方式
2。 验证码的过期时间为5分钟，身份验证在业务场景来说是用户需要马上登录的，所以过期时间可以稍微短一些。
### 验证码的安全性
- 后端:
  1. 验证码的长度为6位随机数
  2. 考虑到用户体验，验证码输错5次以后失效
  3. 认证成功以后删除key[`userAuth_${phoneNumber}`]
  4. [可选] 使用第三方安全服务判断用户是否为真实用户
- 服务器端：
  1. 在`Nginx`中限制IP访问频率
  2. 使用`fail2ban` 检查同IP 对身份验证接口的失败次数，达到对应的 **阈值** 将这个IP扔到黑名单中，过一段时间以后在放出来。
### 短信服务的安全性
之前未接手的一个项目短信被严重盗刷，在一天内少了10W条。原因是产品要求不使用验证码，后端未作验证!对应的服务器也没有对应的安全规则。
- 后端:
  1. 相同手机号60s只能发送一次
  2. 重新发，每隔60S以后且未输错5次发送相同验证码
  3. 使用第三方服务判断是否为真实用户 [验证码现在识别并不难，所以还是买安全服务吧。。。]
- 服务器端：
  1. 在`Nginx`中限制IP访问频率
  2. 使用`fail2ban` 检查同IP 短信验证码调用次数，达到对应的 **阈值** 将这个IP扔到黑名单中，过一段时间以后在放出来。
## REF
[sms-authentication-login-api](https://insights.thoughtworks.cn/sms-authentication-login-api)  
[选redis还是memcache，源码怎么说？](https://mp.weixin.qq.com/s/hOdwK2-7_S7_fi-KVu9_OQ)  
[fail2ban](https://www.fail2ban.org/)  
[Nginx 限制IP访问频率](https://www.w3cschool.cn/nginxsysc/nginxsysc-limit-req.html)